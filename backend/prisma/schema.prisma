// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String?
  googleId      String?   @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  apiKeys       ApiKey[]
  triggers      Trigger[]

  @@map("users")
}

model ApiKey {
  id           String   @id @default(uuid())
  userId       String
  name         String
  keyHash      String   @unique
  lastUsed     DateTime?
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model Trigger {
  id                String   @id @default(uuid())
  userId            String
  name              String
  webhookUrl        String
  payload           Json     // Custom JSON payload
  scheduleType      String   // "one-time" | "recurring" | "interval"
  
  // For one-time triggers
  triggerTime       DateTime?
  
  // For recurring triggers
  interval          Int?     // Minutes
  maxExecutions     Int?     // Optional max count
  executionCount    Int      @default(0)
  
  // For interval triggers
  delayMinutes      Int?     // Minutes to wait before triggering
  
  enabled           Boolean  @default(true)
  metadata          Json?    // Additional data
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  executions        TriggerExecution[]

  @@map("triggers")
}

model TriggerExecution {
  id            String   @id @default(uuid())
  triggerId     String
  executedAt    DateTime @default(now())
  status        String   // "success" | "failure" | "retrying"
  responseCode  Int?
  errorMessage String?
  responseBody String?  // First 1000 chars of response

  trigger       Trigger  @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@map("trigger_executions")
}

